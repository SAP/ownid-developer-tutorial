## Server overview

The server communicates with the Identity Management System in order to authenticate the user with the cryptographic keys.

The server SDK exposes `/ownid/*` routes.
Each route will be used by the OwnID UI SDK or OwnID Web Application.

* POST: `/ownid` - provides an authorization context for the Web SDK
* POST: `/ownid/{context}/start` - starts communication between OwnID Web Application and server
* GET: `/ownid/{context}/challenge` - provides configuration for OwnID Web Application
* POST: `/ownid/{context}/challenge` - transfers user profile data entered on OwnID Web Application page according to configuration
* POST: `/ownid/{context}/challenge/partial` - transfer partial user profile data (public key) generated by OwnID Web Application
* POST: `/ownid/status` - provides user login statuses with specific authorization contexts
* POST: `/ownid/{context}/approval-status` - checks approval status if PIN validation initiated
* POST: `/ownid/{context}/approve` - sets approval resolution for current context


## Server configuration
The configuration can be set manually by editing file [path to yaml file] or by running the configuration tool located in [path to configuration tool]


YAML configuration file

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: <company-name>-deployment # <client-name> - name of company, for example SAP
  namespace: alpha
  labels:
    app: <company-name>
spec:
  revisionHistoryLimit: 1
  replicas: 2
  selector:
    matchLabels:
      app: <company-name>
  template:
    metadata:
      labels:
        app: <company-name>
    spec:
      containers:
        - name: <company-name>
          image: <ownid-image-url> # path to image, ex: 571861302935.dkr.ecr.us-east-2.amazonaws.com/ownid-server-netcore3-gigya-staging:latest
          ports:
            - containerPort: 5002
          env:
            - name: OWNID__CALLBACK_URL
              value: https://<client-name>.ownid.com # public domain name of this deployment - ingress of CNAME
            - name: OWNID__DID # Unique website identifier
              value: did:<client-name>:<did>
            - name: OWNID__NAME # Website name - will be shown on https://sign.ownid.com
              value: <Client name>
            - name: OWNID__DESCRIPTION # Website description - will be shown on https://sign.ownid.com
              value: <client description>
            - name: OWNID__ICON # Website icon - will be shown on https://sign.ownid.com
              value: <client icon base64>
            - name: OWNID__CACHE_TYPE # Type of cache - redis of web-cache (in memory solution for 1 instance of service)
              value: redis
            - name: OWNID__CACHE_CONFIG # Cache config. For redis - redis_uri
              value: <redis uri>
            - name: OWNID__PUB_KEY # Website public key 
              value: <website public key>
            - name: OWNID__PRIVATE_KEY # Website private key 
              value: <website private key>
            - name: OWNID__FIDO2_ENABLED # true, if you want to enable FIDO2 support
              value: <true or false>
            - name: OWNID__FIDO2_PASSWORDLESS_PAGE_URL # should be a subdomain. OwnID team has to create a certifificate for the URL
              value: https://passwordless.<website domain>
            - name: OWNID__FIDO2_RELYING_PARTY_ID # Website domain name
              value: universalid.sap.com
            - name: OWNID__FIDO2_RELYING_PARTY_NAME # Website domain name
              value: UniversalID
            - name: OWNID__FIDO2_ORIGIN # Website address
              value: https://universalid.sap.com
            - name: GIGYA__DATA_CENTER # Gigya data center
              value: us1.gigya.com
            - name: GIGYA__SECRET # Gigya secret
              value: <gigya secret>
            - name: GIGYA__API_KEY # Gigya api key
              value: <gigya api key>
            - name: GIGYA__USER_KEY # Gigya user key
              value: <gigya user key>
            - name: GIGYA__LOGIN_TYPE # Login type: session or IdToken (JWT will be returned instead of creating a session)
              value: IdToken
            - name: ASPNETCORE_ENVIRONMENT # environment
              value: alpha
```

## Server SDK
### Implementing the SDK
1. Create UserProfile class without any fields

```cs
public class UserProfile
{
}
```

2. Implement `IUserHandler<T>`
Need to implement `UserHandler<T>` interface to integrate custom logic into the OwnId authorization process.
You can create a parameterized constructor to get injected parameters. `IUserHandler<T>` instances have a `Transient` lifetime by default. Each method will be called after a user initiates any action (login, register, etc.)

```cs
public class UserHandler : IUserHandler<UserProfile>
{
    public Task UpdateProfileAsync(IUserProfileFormContext<UserProfile> context)
    {
        // some user update profile logic
    }

    public Task<LoginResult<object>> OnSuccessLoginAsync(string did)
    {
        // some user login logic
    }
}
```

3. Add OwnIdSdk services

Go to `StartUp.cs`. Find `ConfigureServices` method and use `AddOwnId(...)` extension at the start to add mandatory services and attach already `UserProfile` and `UserHandler`.

SetKeys method can be removed and also the following one, methodWithBaseSettings, if you set the fields in appsettings.json (manually or using the configuration tool). The configuration tool can either be used to create the key pair only or to get user input for all necessary parameters and set them in appsettings.json.

```cs
public void ConfigureServices(IServiceCollection services)
{
    services.AddOwnId( builder =>
        {
            // previously created UserProfile and UserHandler
            builder.UseUserHandlerWithCustomProfile<UserProfile, UserHandler>();

            // Adding RSA keys by path for JWT signing and application identification
            builder.SetKeys("./keys/my-public-key.pub", "./keys/my-private-key");

            // Set base settings
            builder.WithBaseSettings(x =>
            {
                x.DID = "<your application unique identifier>"; // helps to identify your application
                x.Name = "<your product name>"; // will be shown to users
                x.CallbackUrl = new Uri("https://my-app.com"); // public Uri to this net core app
                                                               // for sending login/register requests
            });
        });
}
```

4. Add OwnIdSdk middleware

Find `Configure` method in `StartUp.cs` and use `UseOwnId()` extension at the start to add register/login requests processors.

```cs
public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    app.UseOwnId();
}
```

### Advanced settings
All configuration settings should be provided in AddOwnId(...) extension method on ConfigureServices application stage. Possible ways of the configuration tuning will be listed below.

#### Configuration parameters
Configuration parameters can either be set in appsettings.json (manually or using the configuration tool). The configuration tool get user input for all necessary parameters and set them in appsettings.json. Alternatively, use method `WithBaseSettings`.

```cs
public void WithBaseSettings([NotNull] Action<IOwnIdCoreConfiguration> modifyAction)
```

A list of these settings can be found in `IOwnIdCoreConfiguration` interface. We will describe them one by one below.

* `Uri` **`OwnIdApplicationUrl`** - OwnId application URI that will be used for authorization. Required. Should use HTTPS in production environments. Should be accessible by OwinId application endpoint. HTTP can only be used for development cases with `IsDevEnvironment` set to `true`

* `Uri` **`CallbackUrl`** -  Uri of OwnIdSdk host. Will be used for the entire OwnID challenge process. Required. Should use HTTPS on production environments. Should be accessible by OwinId application endpoint `OwnIdApplicationUrl`. HTTP can only be used for development cases with `IsDevEnvironment` set to `true`

* `RSA` **`JwtSignCredentials`** - RSA keys for signing JWT token that will be provided for OwnId application requests. Required. You could use helper methods in configuration builder to set keys from file `public void SetKeys([NotNull] string publicKeyPath, [NotNull] string privateKeyPath)` or pass the object by itself `public void SetKeys([NotNull] RSA rsa)`.

* `IProfileConfiguration` **`ProfileConfiguration`** - Profile form fields configuration. Should be set with `IUserHandler<T>` with 'UseUserHandlerWithCustomProfile<TProfile, THandler>()' method in configuration builder.

* `string` **`DID`** - Organization/ product unique identity. Helps to identify your application on par with the public key from `JwtSignCredentials` 

* `string` **`Name`** - Name of organization / product that will be shown to end user on OwinId application page on registration / login / managing profile.  Required.

* `string` **`Icon`** - Icon of organization / product that will be shown to end user on OwinId application page on registration / login / managing profile. Can be stored as URI or base64 encoded format string (`data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==`)

* `string` **`Description`** - Description text that will be shown near the `Name` on OwnId application page for end-user

* `bool` **`IsDevEnvironment`** - Marks if OwnIdSdk is used for development cases

#### Localization settings
All OwnIdSdk parts that require localization use `ILocalizationService` abstraction. 
As for `OwnIdSdk.NetCore3.Web` we created its implementation called `LocalizationService`. It receives the text that should be localized and tries to find it as a key in the resource you define or in default OwnId localization. 
To provide localization resource you can use:
* `SetLocalizationResource` that sets custom localization resource (*.resx, etc.) by its type and name to be used in LocalizationService
```cs
public void SetLocalizationResource([NotNull] Type resourceType, [NotNull] string resourceName)
```
* `SetStringLocalizer` that sets IStringLocalizer to be used in LocalizationService
```cs
public void SetStringLocalizer<TLocalizer>() where TLocalizer : IStringLocalizer
```

#### Cache store settings
OwnId SDK need a fast-reading store to place authorization temporary data. By default, it uses in-memory primitive store, but you can easily override this logic by implementing `ICacheStore` interface and registering its implementation in configuration builder with method `UseCacheStore`.
```cs
public void UseCacheStore<TStore>(ServiceLifetime serviceLifetime) where TStore : class, ICacheStore
```
Where `TStore` is your custom store interaction implementation. It has primitive operations like set, find and remove. 
The `ServiceLifetime` is enum the will describe it's lifecycle in injection mechanism.

